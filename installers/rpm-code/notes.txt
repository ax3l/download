#!/bin/bash
set -euo pipefail

sudo dnf install -y createrepo rpm-sign
cd ~/src/radiasoft/download/installers/rpm-code
mkdir -p run/gnupug run/repo/fedora/27/x86_64/

export GNUPGHOME=$PWD/run/fedora-gpg
gpg --gen-key
gpg --export -a > run/repo/fedora/gpg

key_id=$(gpg --list-keys | perl -ne 'm{pub.*?/(\w+)} && print $1')
[[ $key_id ]]
cat > run/.rpmmacros <<EOF
%_gpg_name $key_id
EOF

# fake out where .rpmmacros lives
HOME=$PWD/run rpm -v --addsign run/repo/fedora/27/x86_64/rscode-test-20180817.223312-1.x86_64.rpm

# first time
createrepo run/repo/fedora/27/x86_64
# after first time
createrepo --update run/repo/fedora/27/x86_64

# --delsign to remove and --resign to replace

install -m 444 /dev/stdin /etc/yum.repos.d/radiasoft.repo <<EOF
[radiasoft-dev]
name=RadiaSoft fedora/27/x86_64 dev
baseurl=http://v.radia.run:1313/fedora/\$releasever/\$basearch
enabled=1
gpgcheck=1
gpgkey=http://v.radia.run:1313/fedora/gpg
EOF
dnf clean all

(cd run/repo; python -m SimpleHTTPServer 1313)

# Will import the key first time
sudo dnf install -y rscode-test

# debugging

dnf clean all #  when hashes or sigs wrong.

# List all keys installed
rpm -qa gpg-pubkey* | xargs rpm -qi
# Grep for specific key:
rpm -qa gpg-pubkey* |grep -i aaaaaaaa
